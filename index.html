<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K·ª≥ Thi T·ªët nghi·ªáp THPT 2026</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .screen {
            display: none;
            min-height: 100vh;
        }
        .active-screen {
            display: flex;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .login-card {
            width: 100%;
            max-width: 450px;
            padding: 2.5rem;
        }
        .subject-card {
            width: 100%;
            max-width: 1100px;
        }
        .exam-panel {
            max-height: calc(100vh - 8rem);
            overflow-y: auto;
        }
        .question-nav-item {
            cursor: pointer;
            transition: all 0.2s;
        }
        .question-nav-item.active {
            background-color: #3b82f6;
            color: white;
            font-weight: 700;
        }
        .question-nav-item.answered {
            background-color: #10b981;
            color: white;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #f3f4f6;
            color: #1f2937;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #e5e7eb;
        }
        #question-nav::-webkit-scrollbar {
            display: none;
        }
        #question-nav {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .question-option label {
            display: block;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .question-option label:hover {
            background-color: #f3f4f6;
        }
        .question-option input:checked + label {
            background-color: #dbeafe;
            border-color: #3b82f6;
            font-weight: 600;
        }
        .result-box {
            border: 2px solid #065f46;
        }
        .section-title {
            background-color: #e0f2fe;
            color: #0c4a6e;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transform: translateY(-50px);
            transition: transform 0.3s ease-in-out;
        }
        .modal.open .modal-content {
            transform: translateY(0);
        }
        .question-item {
            border: 1px solid #e5e7eb;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            background-color: #fafafa;
        }
        .option-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .option-input-group input[type="radio"] {
            margin-right: 0.5rem;
        }
        /* Custom styling for the SVG logo container */
        .logo-container {
            width: 96px; 
            height: 96px; 
            margin: 0 auto;
            margin-bottom: 1rem;
            border-radius: 9999px; 
            border: 2px solid #e5e7eb; 
            overflow: hidden;
        }
        .svg-logo {
            display: block;
            margin: 0 auto;
        }
        /* Style cho √¥ ƒëi·ªÅn s·ªë */
        .numeric-input-cell {
            width: 50px;
            height: 50px;
            text-align: center;
            border: 2px solid #3b82f6;
            border-radius: 0.375rem;
            font-size: 1.25rem;
            font-weight: 700;
            outline: none;
            transition: border-color 0.2s;
        }
        .numeric-input-cell:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        @media (max-width: 768px) {
            .exam-layout {
                flex-direction: column;
            }
            .question-content {
                width: 100%;
                padding-right: 0;
            }
            .question-navigation {
                width: 100%;
                border-left: none;
                border-top: 1px solid #e5e7eb;
                margin-top: 1rem;
                padding-top: 1rem;
            }
            .question-nav-item {
                width: 48px;
                height: 48px;
            }
            .login-card {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>

    <!-- 1. GIAO DI·ªÜN ƒêƒÇNG NH·∫¨P -->
    <div id="login-screen" class="screen active-screen items-center justify-center p-4">
        <div class="card login-card text-center">
            <div class="mb-6">
                                
                <h1 class="text-xl font-bold text-gray-800">BAN QU·∫¢N L√ù CH·∫§T L∆Ø·ª¢NG</h1>
                <h2 class="text-lg font-medium text-gray-600">(d√†nh cho th√≠ sinh& h·ªçc vi√™n)</h2>
            </div>
            
            <h3 class="text-2xl font-bold mb-6 text-gray-700">ƒêƒÇNG NH·∫¨P H·ªÜ TH·ªêNG</h3>
            
            <form id="login-form">
                <div class="mb-4 text-left">
                    <label for="ma_thi_sinh" class="block text-sm font-medium text-gray-700">M√£ s·ªë/ S·ªë B√°o Danh*</label>
                    <input type="text" id="ma_thi_sinh" name="ma_thi_sinh" placeholder="" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" maxlength="8" inputmode="numeric">
                </div>
                <div class="mb-4 text-left">
                    <label for="ho_ten" class="block text-sm font-medium text-gray-700">H·ªç v√† t√™n*</label>
                    <input type="text" id="ho_ten" name="ho_ten" placeholder="Nguyen Van A" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div class="mb-6 text-left">
                    <label for="mat_khau" class="block text-sm font-medium text-gray-700">M·∫≠t kh·∫©u*</label>
                    <input type="password" id="mat_khau" name="mat_khau" placeholder="" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <p id="login-error" class="text-red-500 text-sm mt-1 hidden">Th√¥ng tin ƒëƒÉng nh·∫≠p kh√¥ng h·ª£p l·ªá.</p>
                </div>
                <div class="mb-6 text-left">
                    <label for="dot_thi" class="block text-sm font-medium text-gray-700">ƒê·ª£t thi *</label>
                    <select id="dot_thi" name="dot_thi" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option>K·ª≥ thi t·ªët nghi·ªáp THPT 2026</otion>
			<option>K·ª≥ thi ƒê√°nh gi√° nƒÉng l·ª±c ƒê·∫°i h·ªçc Qu·ªëc gia Th√†nh ph·ªë H·ªì Ch√≠ Minh( V-ACT) ƒê·ª£t 1</option>
			<option>K·ª≥ thi ƒê√°nh gi√° nƒÉng l·ª±c ƒê·∫°i h·ªçc Qu·ªëc gia Th√†nh ph·ªë H·ªì Ch√≠ Minh( V-ACT) ƒê·ª£t 2</option>
			<option>K·ª≥ thi ƒê√°nh gi√° nƒÉng l·ª±c chuy√™n bi·ªát Tr∆∞·ªùng ƒê·∫°i h·ªçc S∆∞ ph·∫°m Th√†nh ph·ªë H·ªì Ch√≠ Minh( H-SCA) ƒê·ª£t 1</option>
			<option>K·ª≥ thi ƒê√°nh gi√° nƒÉng l·ª±c chuy√™n bi·ªát Tr∆∞·ªùng ƒê·∫°i h·ªçc S∆∞ ph·∫°m Th√†nh ph·ªë H·ªì Ch√≠ Minh( H-SCA) ƒê·ª£t 2</option>
			<option>K·ª≥ thi ƒê√°nh gi√° nƒÉng l·ª±c chuy√™n bi·ªát Tr∆∞·ªùng ƒê·∫°i h·ªçc S∆∞ ph·∫°m Th√†nh ph·ªë H·ªì Ch√≠ Minh( H-SCA) ƒê·ª£t 3</option>
                    </select>
                </div>
                <button type="button" onclick="login()" class="btn-primary w-full py-3 text-lg">ƒêƒÉng nh·∫≠p</button>
            </form>

            <p class="mt-8 text-xs text-gray-400">ü™Ωüßëüèª‚Äç‚öïÔ∏èü•º Tr.G Nguy·ªÖn H·ªØu Huy- TLeducation</p>
        </div>
    </div>

    <!-- 2. GIAO DI·ªÜN CH·ªåN ƒê·ªÄ THI (TH√ç SINH) -->
    <div id="subject-selection-screen" class="screen items-center justify-center p-4">
        <div class="card subject-card p-6">
            <h1 class="text-center text-3xl font-bold mb-8 text-gray-800">K·ª≤ THI T·ªêT NGHI·ªÜP THPT 2026</h1>
            
            <!-- TH√îNG TIN TH√ç SINH & H·ªòI ƒê·ªíNG THI (ƒê·ªÇ TR·ªêNG) -->
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <div class="p-4 bg-blue-50 rounded-lg">
                    <h2 class="font-bold text-lg mb-2 text-blue-800">TH√îNG TIN TH√ç SINH</h2>
                    <p class="text-sm"><span class="font-medium">H·ªç v√† t√™n:</span> <span id="info-ho_ten">...</span></p>
                    <p class="text-sm"><span class="font-medium">SBD:</span> <span id="info-sbd">...</span></p>
		<p class="text-sm"><span class="font-medium">Ng√†y sinh:</span> <input type="text" value="dd/mm/yy " class="w-full bg-transparent border-b border-green-200 focus:border-green-500 outline-none"></p>
		<p class="text-sm"><span class="font-medium">N∆°i sinh:</span> <input type="text" value="" class="w-full bg-transparent border-b border-green-200 focus:border-green-500 outline-none"></p>

                </div>
                
                <div class="p-4 bg-green-50 rounded-lg">
                    <h2 class="font-bold text-lg mb-2 text-green-800">H·ªòI ƒê·ªíNG THI</h2>
                    <p class="text-sm"><span class="font-medium">H·ªôi ƒë·ªìng thi:</span> <input type="text" value="S·ªü GDƒêT " class="w-full bg-transparent border-b border-green-200 focus:border-green-500 outline-none"></p>
                    <p class="text-sm"><span class="font-medium">ƒêi·ªÉm thi:</span> <input type="text" value="" class="w-full bg-transparent border-b border-green-200 focus:border-green-500 outline-none"></p>
                    <p class="text-sm"><span class="font-medium">Ph√≤ng thi:</span> <input type="text" value="Ph√≤ng " class="w-full bg-transparent border-b border-green-200 focus:border-green-500 outline-none"></p>
                </div>
            </div>

            <!-- DANH S√ÅCH M√îN THI -->
            <div class="p-6 bg-gray-50 rounded-lg">
                <h2 class="font-bold text-xl mb-4 text-gray-800">DANH S√ÅCH M√îN THI</h2>
                       <div id="subject-list" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4">
                    <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c t·∫°o ra b·∫±ng JavaScript -->
                </div>
            </div>
            
            <div class="text-center mt-6">
                <button onclick="changeScreen('login-screen')" class="btn-secondary px-6">Quay l·∫°i</button>
            </div>
        </div>
    </div>

    <!-- Modal nh·∫≠p M√£ l·ªõp v√† M·∫≠t kh·∫©u -->
    <div id="class-login-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 modal">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm modal-content">
            <h3 class="text-xl font-bold mb-4">V√†o Ph√≤ng Thi: <span id="modal-subject-name" class="text-blue-600"></span></h3>
            <p class="text-sm text-gray-500 mb-4">Vui l√≤ng nh·∫≠p M√£ l·ªõp v√† M·∫≠t kh·∫©u.</p>
            <form id="class-login-form">
                <div class="mb-4">
                    <label for="class_code_input" class="block text-sm font-medium text-gray-700">M√£ l·ªõp thi *</label>
                    <input type="text" id="class_code_input" placeholder="Nh·∫≠p M√£ l·ªõp (VD: L001)" class="w-full border border-gray-300 rounded-md p-1.5 focus:border-blue-500 outline-none">
                </div>
                <div class="mb-6">
                    <label for="class_password_input" class="block text-sm font-medium text-gray-700">M·∫≠t kh·∫©u l·ªõp thi *</label>
                    <input type="password" id="class_password_input" placeholder="Nh·∫≠p M·∫≠t kh·∫©u l·ªõp" class="w-full border border-gray-300 rounded-md p-1.5 focus:border-blue-500 outline-none">
                    <p id="class-login-error" class="text-red-500 text-sm mt-1 hidden">M√£ l·ªõp ho·∫∑c M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.</p>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="hideClassLoginModal()" class="btn-secondary">H·ªßy</button>
                    <button type="submit" class="btn-primary">V√†o thi</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 2B. GIAO DI·ªÜN ADMIN -->
    <div id="admin-screen" class="screen flex-col p-4">
        <div class="max-w-7xl mx-auto w-full">
            <h1 class="text-3xl font-bold mb-4 text-blue-700">H·ªÜ TH·ªêNG QU·∫¢N L√ù L·ªöP& ƒê·ªÄ THI</h1>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold">Ch√†o m·ª´ng!</h2>
                <div class="space-x-4">
                    <button onclick="changeScreen('exam-editor-screen')" class="btn-primary py-2 bg-purple-600 hover:bg-purple-700">T·∫°o v√† Qu·∫£n l√Ω ƒê·ªÅ thi</button>
                    <button onclick="changeScreen('account-management-screen')" class="btn-primary py-2 bg-indigo-600 hover:bg-indigo-700">Qu·∫£n l√Ω T√†i kho·∫£n H·ªçc vi√™n& Th√≠ sinh</button>
                    <button onclick="changeScreen('login-screen')" class="btn-secondary">ƒêƒÉng xu·∫•t</button>
                </div>
            </div>

            <div class="grid md:grid-cols-3 gap-6">
                <!-- 1. T·∫°o v√† Qu·∫£n l√Ω ƒê·ªÅ thi -->
                <div class="card p-4 bg-yellow-50">
                    <h3 class="font-bold text-lg mb-2 text-yellow-800">1. T·∫°o/Qu·∫£n l√Ω ƒê·ªÅ thi</h3>
                    <p class="text-sm text-gray-700">Ch·ªânh s·ª≠a ƒë·ªÅ thi, M√£ l·ªõp v√† M·∫≠t kh·∫©u l·ªõp thi.</p>
                    <button onclick="changeScreen('exam-editor-screen')" class="btn-primary mt-2 w-full py-2 bg-yellow-600 hover:bg-yellow-700">Ch·ªânh s·ª≠a C·∫•u h√¨nh</button>
                </div>

                <!-- 2. Reset D·ªØ li·ªáu -->
                <div class="card p-4 bg-red-50">
                    <h3 class="font-bold text-lg mb-2 text-red-800">2. Reset D·ªØ li·ªáu</h3>
                    <p class="text-sm text-gray-700">X√≥a to√†n b·ªô d·ªØ li·ªáu th√≠ sinh v√† ƒëi·ªÉm s·ªë.</p>
                    <button class="btn-primary mt-2 w-full py-2 bg-red-600 hover:bg-red-700" onclick="resetTestData()">Reset K·∫øt qu·∫£ Thi</button>
                </div>
                
                <!-- 3. Qu·∫£n l√Ω T√†i kho·∫£n H·ªçc vi√™n& Th√≠ sinh -->
                <div class="card p-4 bg-blue-50">
                    <h3 class="font-bold text-lg mb-2 text-blue-800">3. T√†i kho·∫£n H·ªçc vi√™n& Th√≠ sinh</h3>
                    <p class="text-sm text-gray-700">Qu·∫£n l√Ω t√†i kho·∫£n H·ªçc vi√™n& Th√≠ sinh ƒë√£ ƒë∆∞·ª£c t·∫°o.</p>
                    <button onclick="changeScreen('account-management-screen')" class="btn-primary mt-2 w-full py-2 bg-blue-600 hover:bg-blue-700">Qu·∫£n l√Ω T√†i kho·∫£n H·ªçc vi√™n& Th√≠ sinh</button>
                </div>
            </div>

            <!-- Danh s√°ch thi& ƒêi·ªÉm s·ªë (ƒê√£ s·ª≠a l·ªói v√† th√™m c·ªôt/b·ªô l·ªçc) -->
            <div class="card p-6 mt-6">
                <h3 class="font-bold text-xl mb-4 text-gray-800">DANH S√ÅCH THI& K·∫æT QU·∫¢ THI</h3>
                
                <!-- B·ªô l·ªçc -->
                <div class="mb-4 flex space-x-4">
                    <select id="filter-subject" onchange="loadStudentResults()" class="border border-gray-300 rounded-md p-2">
                        <option value="">-- L·ªçc theo M√¥n thi --</option>
                        <!-- Options m√¥n h·ªçc ƒë∆∞·ª£c th√™m b·∫±ng JS -->
                    </select>
                    <select id="filter-class" onchange="loadStudentResults()" class="border border-gray-300 rounded-md p-2">
                        <option value="">-- L·ªçc theo M√£ l·ªõp --</option>
                        <!-- Options m√£ l·ªõp ƒë∆∞·ª£c th√™m b·∫±ng JS -->
                    </select>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">STT</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">H·ªç v√† t√™n</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">S·ªë b√°o danh</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">M√¥n thi</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">M√£ l·ªõp</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">M√£ ƒë·ªÅ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ƒêi·ªÉm s·ªë </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Th·ªùi gian n·ªôp</th>
                            </tr>
                        </thead>
                        <tbody id="student-list" class="bg-white divide-y divide-gray-200">
                            <!-- D·ªØ li·ªáu th√≠ sinh s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 2C. GIAO DI·ªÜN T·∫†O ƒê·ªÄ THI (EXAM EDITOR) -->
    <div id="exam-editor-screen" class="screen flex-col p-4">
        <div class="max-w-7xl mx-auto w-full">
            <h1 class="text-3xl font-bold mb-4 text-purple-700">ADMIN: C√îNG C·ª§ T·∫†O V√Ä QU·∫¢N L√ù ƒê·ªÄ THI</h1>
            <div class="card p-6 mb-6">
                <h2 class="text-xl font-semibold mb-3">C·∫•u h√¨nh ƒê·ªÅ thi & L·ªõp thi</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">M√¥n h·ªçc</label>
                        <select id="editor-subject-select" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                            <!-- Options m√¥n h·ªçc ƒë∆∞·ª£c th√™m b·∫±ng JS -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">M√£ L·ªõp Thi</label>
                        <input type="text" id="editor-class-code" value="L001" placeholder="M√£ l·ªõp thi" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">M·∫≠t kh·∫©u L·ªõp Thi</label>
                        <input type="text" id="editor-class-password" value="pass123" placeholder="M·∫≠t kh·∫©u l·ªõp thi" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Th·ªùi gian (ph√∫t)</label>
                        <input type="number" id="editor-time-limit" value="50" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                    </div>
                    <div class="md:col-span-1">
                        <label class="block text-sm font-medium text-gray-700">Thang ƒëi·ªÉm (t·ªïng)</label>
                        <input type="number" id="editor-total-points" value="10" class="mt-1 block w-full border border-gray-300 rounded-md p-2 bg-gray-100" disabled>
                    </div>
                </div>
                            </div>

            <!-- V√πng Qu·∫£n l√Ω M√£ ƒë·ªÅ (Shuffle Keys) - C·∫≠p nh·∫≠t 4 ch·ªØ s·ªë -->
            <div class="card p-6 mb-6 bg-blue-50">
                <h2 class="text-xl font-semibold mb-3 text-blue-800">Qu·∫£n l√Ω M√£ ƒë·ªÅ ƒê·∫£o (Shuffle Keys - 4 ch·ªØ s·ªë)</h2>
                <div class="flex space-x-4 items-center mb-4">
                    <p class="text-sm font-medium">M√£ ƒë·ªÅ g·ªëc (Kh√¥ng ƒë·∫£o): <span class="font-bold text-blue-700">0000</span></p>
                    <button onclick="generateRandomExamCode()" class="btn-primary py-1 px-3 bg-blue-600 hover:bg-blue-700">T·∫°o M√£ ƒë·ªÅ ng·∫´u nhi√™n m·ªõi (4 ch·ªØ s·ªë)</button>
                </div>
                <div class="flex flex-wrap gap-2" id="exam_codes_list_editor">
                    <!-- M√£ ƒë·ªÅ ƒë·∫£o (ngo√†i m√£ g·ªëc 0000) s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                </div>
            </div>

            <!-- V√πng ch·ªânh s·ª≠a c√¢u h·ªèi -->
            <div class="card p-6">
                <h2 class="text-xl font-semibold mb-4">Danh s√°ch C√¢u h·ªèi (<span id="editor-question-count">0</span> c√¢u)</h2>
                
                <div id="questions-editor-container">
                    <!-- Danh s√°ch c√¢u h·ªèi s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                </div>

                <button onclick="addQuestionEditor()" class="btn-primary mt-4 py-2 px-4 w-full bg-green-500 hover:bg-green-600">
                    + Th√™m C√¢u h·ªèi M·ªõi
                </button>
            </div>
            
            <div class="mt-6 flex justify-between">
                <button onclick="changeScreen('admin-screen')" class="btn-secondary">Quay l·∫°i</button>
                <button onclick="saveExamData()" class="btn-primary py-3 px-8 bg-blue-600 hover:bg-blue-700">L∆ØU C·∫§U H√åNH ƒê·ªÄ THI</button>
            </div>
        </div>
    </div>
    
    <!-- 2D. GIAO DI·ªÜN QU·∫¢N L√ù T√ÄI KHO·∫¢N -->
    <div id="account-management-screen" class="screen flex-col p-4">
        <div class="max-w-7xl mx-auto w-full">
            <h1 class="text-3xl font-bold mb-4 text-indigo-700">ADMIN: QU·∫¢N L√ù T√ÄI KHO·∫¢N </h1>
            
            <!-- Th√™m T√†i kho·∫£n -->
            <div class="card p-6 mb-6">
                <h2 class="text-xl font-semibold mb-3">Th√™m T√†i kho·∫£n m·ªõi</h2>
                <form id="add_account_form" class="grid md:grid-cols-4 gap-4">
                    <input type="text" id="new_sbd" placeholder="M√£ s·ªë/S·ªë b√°o danh" required class="block border border-gray-300 rounded-md p-2" maxlength="8" inputmode="numeric">
                    <input type="text" id="new_name" placeholder="H·ªç v√† t√™n" required class="block border border-gray-300 rounded-md p-2">
                    <input type="password" id="new_password" placeholder="M·∫≠t kh·∫©u" required class="block border border-gray-300 rounded-md p-2">
                    <button type="submit" class="btn-primary bg-green-600 hover:bg-green-700">T·∫°o T√†i kho·∫£n</button>
                </form>
            </div>
            
            <!-- Danh s√°ch T√†i kho·∫£n -->
            <div class="card p-6">
                <h2 class="text-xl font-semibold mb-4">Danh s√°ch T√†i kho·∫£n ƒë√£ t·∫°o (<span id="account_count">0</span>)</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">M√£ s·ªë/SBD</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">H·ªç v√† t√™n</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">M·∫≠t kh·∫©u</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="accounts_table" class="bg-white divide-y divide-gray-200">
                            <!-- T√†i kho·∫£n s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="mt-6">
                <button onclick="changeScreen('admin-screen')" class="btn-secondary">Quay l·∫°i Admin</button>
            </div>
        </div>
    </div>


    <!-- 3. GIAO DI·ªÜN ƒê·ªÄ THI (TH√ç SINH) -->
    <div id="exam-screen" class="screen flex-col">
        <!-- Header (Nav Bar) -->
        <header class="flex-shrink-0 bg-white shadow-md p-4">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="text-sm font-medium text-gray-700">
                    <p><span id="exam-ho_ten">...</span> | SBD: <span id="exam-sbd">...</span> | L·ªõp: <span id="exam-class-display" class="font-bold text-green-600">...</span></p>
                    <p>M√¥n thi: <span class="font-bold text-blue-600" id="exam-subject-display">H√ìA H·ªåC</span> | M√£ ƒë·ªÅ: <span id="exam-code-display">...</span></p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2 text-xl font-bold text-red-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span id="timer">50:00</span>
                    </div>
                    <button onclick="confirmSubmission()" class="btn-primary py-2 px-4">N·ªòP B√ÄI</button>
                </div>
            </div>
        </header>

        <!-- N·ªôi dung thi -->
        <main class="flex-grow p-4 overflow-hidden">
            <div class="max-w-7xl mx-auto h-full flex exam-layout">
                <!-- Khu v·ª±c ƒë·ªÅ thi (tr√°i) -->
                <div id="exam-content" class="w-3/4 question-content pr-4 h-full exam-panel">
                    <div class="flex justify-between items-center mb-4">
                        <div class="space-x-2">
                            <button onclick="prevQuestion()" class="btn-secondary px-4">Quay l·∫°i</button>
                            <button onclick="nextQuestion()" class="btn-primary px-4">Ti·∫øp theo</button>
                        </div>
                        <span class="text-lg font-semibold text-gray-700">S·ªë c√¢u ƒë√£ tr·∫£ l·ªùi: <span id="answered-count">0</span>/<span id="total-questions">0</span></span>
                    </div>
                    
                    <!-- V√πng hi·ªÉn th·ªã c√¢u h·ªèi -->
                    <div id="question-container" class="card p-6 min-h-[400px]">
                        <div class="text-center text-gray-500">ƒêang t·∫£i ƒë·ªÅ thi...</div>
                    </div>
                </div>

                <!-- Thanh ƒëi·ªÅu h∆∞·ªõng c√¢u h·ªèi (ph·∫£i) -->
                <div class="w-1/4 question-navigation flex-shrink-0 pl-4">
                    <div class="card p-4 h-full flex flex-col">
                        <h3 class="font-bold text-lg mb-3">B·∫¢NG ƒêI·ªÄU H∆Ø·ªöNG</h3>
                        
                        <div id="question-nav" class="flex flex-col gap-4 overflow-y-auto exam-panel">
                            <!-- N·ªôi dung ƒë∆∞·ª£c th√™m b·∫±ng JS -->
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Modal x√°c nh·∫≠n n·ªôp b√†i -->
        <div id="submission-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 modal">
            <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm modal-content">
                <h3 class="text-xl font-bold mb-4">X√°c nh·∫≠n n·ªôp b√†i</h3>
                <p class="mb-6">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i kh√¥ng? Th·ªùi gian c√≤n l·∫°i s·∫Ω b·ªã h·ªßy.</p>
                <div class="flex justify-end space-x-4">
                    <button onclick="hideSubmissionModal()" class="btn-secondary">H·ªßy</button>
                    <button onclick="submitExam()" class="btn-primary">N·ªôp b√†i</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. GIAO DI·ªÜN K·∫æT QU·∫¢ -->
    <div id="result-screen" class="screen flex-col items-center justify-center p-4">
        <h1 class="text-3xl font-bold mb-10 text-gray-800">GIAO DI·ªÜN K·∫æT QU·∫¢ THI</h1>
        <div class="card result-box p-8 w-full max-w-lg text-center border-4 border-green-700">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">K·∫øt qu·∫£ thi</h2>
            <div class="text-left space-y-3 text-lg">
                <p class="font-bold text-green-700">Ch√∫c m·ª´ng B·∫°n ƒë√£ n·ªôp b√†i thi th√†nh c√¥ng!</p>
                <p><span class="font-medium">T·ªïng s·ªë c√¢u tr·∫£ l·ªùi:</span> <span id="result-answered"></span>/<span id="result-total"></span></p>
                <p><span class="font-medium">S·ªë c√¢u ƒë√∫ng:</span> <span id="result-correct"></span></p>
                <p class="text-2xl font-bold text-blue-700"><span class="font-medium">S·ªë ƒëi·ªÉm ƒë·∫°t ƒë∆∞·ª£c:</span> <span id="result-score"></span>/10</p>
            </div>
            
            <button onclick="changeScreen('login-screen')" class="btn-primary mt-8 px-8 py-3">Ho√†n th√†nh</button>
        </div>
    </div>
    
    <!-- Modal ch·ªçn Sub-m√¥n (ƒê√£ ph·ª•c h·ªìi) -->
    <div id="subject-option-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 modal">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm modal-content">
            <h3 class="text-xl font-bold mb-4" id="modal-subject-title">Ch·ªçn t√πy ch·ªçn</h3>
            <div id="modal-options-container" class="space-y-3">
                <!-- Options will be dynamically inserted here -->
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button onclick="hideSubjectOptionsModal()" class="btn-secondary">H·ªßy</button>
            </div>
        </div>
    </div>


    <script>
        // --- C√ÅC H·∫∞NG S·ªê V√Ä BI·∫æN TO√ÄN C·ª§C ---
        const ADMIN_CODE = '22122007';
        const ADMIN_PASS = 'Huuhuy@2212_admin_chemistry';
        const STUDENT_DEFAULT_PASS = 'HOAHOCVUIVE';
        const STORAGE_KEY_RESULTS = 'exam_student_results_v4'; // C·∫≠p nh·∫≠t phi√™n b·∫£n
        const STORAGE_KEY_CONFIG = 'exam_config_v4'; // C·∫•u h√¨nh ƒë·ªÅ thi/l·ªõp thi
        const STORAGE_KEY_ACCOUNTS = 'exam_student_accounts';
        const SBD_LENGTH = 8; 
        const EXAM_CODE_LENGTH = 4; // M√£ ƒë·ªÅ 4 ch·ªØ s·ªë
        
        let currentScreen = 'login-screen';
        let currentQuestionIndex = 0;
        let timerInterval = null;
        let userInfo = { ho_ten: '', ma_thi_sinh: '', exam_code: null, class_code: null, subject_name: null }; 
        let timeLeft = 0; 
        let activeExamConfig = null; 

        // D·ªØ li·ªáu ƒë·ªÅ thi m·∫∑c ƒë·ªãnh (ch·ªâ d√πng n·∫øu ch∆∞a c√≥ c·∫•u h√¨nh) - C·∫≠p nh·∫≠t M√£ ƒë·ªÅ 4 ch·ªØ s·ªë
        const DEFAULT_EXAM_DATA = {
            subjectKey: "HOAHOC",
            className: 'L001',
            classPass: 'pass123',
            timeLimit: 50 * 60, // 50 ph√∫t
            examCodes: ['0000', '0001', '0002'], // M√£ ƒë·ªÅ 4 ch·ªØ s·ªë l√† m·∫∑c ƒë·ªãnh
            points: {
                "Ph·∫ßn I": { count: 18, total: 4.5, perQ: 4.5 / 18 },
                "Ph·∫ßn II": { count: 4, total: 4.0, perQ: 1.0 },
                "Ph·∫ßn III": { count: 6, total: 1.5, perQ: 1.5 / 6 },
            },
            questions: [
                { id: 1, section: "Ph·∫ßn I", text: "ƒê·ªô dinh d∆∞·ª°ng c·ªßa ph√¢n l√¢n ƒë∆∞·ª£c ƒë√°nh gi√° b·∫±ng h√†m l∆∞·ª£ng ph·∫ßn trƒÉm n√†o t∆∞∆°ng ·ª©ng v·ªõi l∆∞·ª£ng phosphorus c√≥ trong th√†nh ph·∫ßn c·ªßa n√≥?", options: ["P", "P2O", "P2O5", "PO2"], answer: "P2O5", selected: null, pointValue: 0.25, correctDetails: { type: 'MC', answerIndex: 2 } },
                { id: 2, section: "Ph·∫ßn I", text: "Nh·ªØng t√≠nh ch·∫•t v·∫≠t l√≠ chung c·ªßa kim lo·∫°i (d·∫´n ƒëi·ªán, d·∫´n nhi·ªát, d·∫ªo, √°nh kim) g√¢y n√™n b·ªüi?", options: ["c√°c electron t·ª± do trong m·∫°ng tinh th·ªÉ kim lo·∫°i.", "ki·ªÉu c·∫•u t·∫°o m·∫°ng tinh th·ªÉ kim lo·∫°i.", "kh·ªëi l∆∞·ª£ng ri√™ng c·ªßa kim lo·∫°i.", "t√≠nh ch·∫•t c·ªßa kim lo·∫°i."], answer: "c√°c electron t·ª± do trong m·∫°ng tinh th·ªÉ kim lo·∫°i.", selected: null, pointValue: 0.25, correctDetails: { type: 'MC', answerIndex: 0 } },
                { id: 19, section: "Ph·∫ßn II", text: "C√¢u 1. V·ªÅ Maltose: (a) CTPT C12H22O11. (b) C√≥ ph·∫£n ·ª©ng Tollens. (c) Nh√≥m ‚ÄìOH ·ªü C1 v√† C4 l√† hemiacetal. (d) Gi√° tr·ªã m k·∫øt t·ªßa thu ƒë∆∞·ª£c l√† 1555,2g.", options: ["(a) v√† (b)", "(a), (b), v√† (d)", "(a), (b), (c)", "Kh√¥ng c√≥ ƒë√°p √°n n√†o"], answer: "(a), (b), v√† (d)", selected: null, pointValue: 1.0, correctDetails: { type: 'TF', correctAnswers: [true, true, false, true], subOptions: ["(a) CTPT C12H22O11", "(b) C√≥ ph·∫£n ·ª©ng Tollens", "(c) Nh√≥m ‚ÄìOH ·ªü C1 v√† C4 l√† hemiacetal", "(d) Gi√° tr·ªã m k·∫øt t·ªßa thu ƒë∆∞·ª£c l√† 1555,2g"] } },
                { id: 20, section: "Ph·∫ßn II", text: "C√¢u 2. V·ªÅ ph·ª©c ch·∫•t nit∆° (A2) c·ªßa Ruteni(II): (a) Ph∆∞∆°ng tr√¨nh ph·∫£n ·ª©ng ƒë√∫ng. (b) S·ªë oxi h√≥a Ru trong A2 l√† 0. (c) C·∫•u h√¨nh Ru2+: [Kr]4d75s3. (d) Lai h√≥a sp3d2.", options: ["(a) v√† (d)", "(a), (b), v√† (d)", "Ch·ªâ (a)", "T·∫•t c·∫£ ƒë·ªÅu sai"], answer: "Ch·ªâ (a)", selected: null, pointValue: 1.0, correctDetails: { type: 'TF', correctAnswers: [true, false, false, false], subOptions: ["(a) Ph∆∞∆°ng tr√¨nh ph·∫£n ·ª©ng ƒë√∫ng", "(b) S·ªë oxi h√≥a Ru trong A2 l√† 0", "(c) C·∫•u h√¨nh Ru2+: [Kr]4d75s3", "(d) Lai h√≥a sp3d2"] } }, 
                { id: 23, section: "Ph·∫ßn III", text: "S·∫£n xu·∫•t 3,6 tri·ªáu vi√™n n√©n aspirin (100mg/vi√™n, H=80%) c·∫ßn m kg salicylic acid (C7H6O3). Gi√° tr·ªã c·ªßa m b·∫±ng bao nhi√™u? (l√†m tr√≤n ƒë·∫øn h√†ng ƒë∆°n v·ªã)", options: ["400", "500", "600", "700"], answer: "500", selected: null, pointValue: 0.25, correctDetails: { type: 'NUMERIC', answers: ["5", "0", "0", ""] } },
                { id: 28, section: "Ph·∫ßn III", text: "X√°c ƒë·ªãnh s·ªë ph·ªëi tr√≠ trong c√°c ph·ª©c sau, ƒëi·ªÅn theo th·ª© t·ª± (c), (b), (a):", options: ["664", "666", "466", "446"], answer: "664", selected: null, pointValue: 0.25, correctDetails: { type: 'NUMERIC', answers: ["6", "6", "4", ""] } }, 
            ].map(q => ({
                 ...q,
                 correctIndex: q.options ? q.options.indexOf(q.answer) : -1
            }))
        };

        // C·∫≠p nh·∫≠t c·∫•u tr√∫c ALL_SUBJECTS ƒë·ªÉ ch·ª©a sub-m√¥n v√† key t∆∞∆°ng ·ª©ng
        const ALL_SUBJECTS = [
            { name: 'Ng·ªØ vƒÉn', status: 'disabled', key: 'NGUVAN' }, 
            { name: 'To√°n', status: 'disabled', key: 'TOAN' }, 
            { name: 'V·∫≠t l√Ω', status: 'disabled', key: 'VATLY' },
            { name: 'H√≥a h·ªçc', status: 'ready', key: 'HOAHOC' }, 
            { name: 'Sinh h·ªçc', status: 'disabled', key: 'SINHHOC' }, 
            { name: 'L·ªãch s·ª≠', status: 'disabled', key: 'LICHSU' }, 
            { name: 'ƒê·ªãa l√Ω', status: 'disabled', key: 'DIALY' }, 
            { name: 'Gi√°o d·ª•c kinh t·∫ø v√† ph√°p lu·∫≠t', status: 'disabled', key: 'GDPL' }, 
            { name: 'Tin h·ªçc', status: 'disabled', key: 'TINHOC' },
            // M√¥n C√¥ng ngh·ªá
            { name: 'C√¥ng ngh·ªá', status: 'options', key: 'CONGNGHE', options: [
                { name: 'CN C√¥ng nghi·ªáp', key: 'CN_CONGNGHIEP' },
                { name: 'CN N√¥ng nghi·ªáp', key: 'CN_NONGNGHIEP' }
            ]}, 
            // M√¥n Ngo·∫°i ng·ªØ
            { name: 'Ngo·∫°i ng·ªØ', status: 'options', key: 'NGOAINGU', options: [
                { name: 'Ti·∫øng Anh', key: 'NN_TIENGANH' },
                { name: 'Ti·∫øng Nga', key: 'NN_TIENGNGA' },
                { name: 'Ti·∫øng Ph√°p', key: 'NN_TIENGFAP' },
                { name: 'Ti·∫øng Trung', key: 'NN_TIENGTRUNG' },
                { name: 'Ti·∫øng ƒê·ª©c', key: 'NN_TIENGDUC' },
                { name: 'Ti·∫øng Nh·∫≠t', key: 'NN_TIENGNHAT' },
                { name: 'Ti·∫øng H√†n', key: 'NN_TIENGHAN' }
            ]} 
        ];
        
        // --- LOGIC KH·ªûI T·∫†O V√Ä L∆ØU TR·ªÆ ---
        
        function loadExamConfig() {
            const storedData = localStorage.getItem(STORAGE_KEY_CONFIG);
            let configData;

            if (storedData) {
                configData = JSON.parse(storedData);
            } else {
                configData = { configs: [DEFAULT_EXAM_DATA] };
            }
            
            // X·ª≠ l√Ω chuy·ªÉn ƒë·ªïi m√£ ƒë·ªÅ c≈© (3 ch·ªØ s·ªë) sang 4 ch·ªØ s·ªë n·∫øu c·∫ßn
            configData.configs.forEach(config => {
                if (config.examCodes && config.examCodes.some(code => code.length < EXAM_CODE_LENGTH)) {
                    config.examCodes = config.examCodes.map(code => code.padStart(EXAM_CODE_LENGTH, '0'));
                }
                 // ƒê·∫£m b·∫£o questions ƒë∆∞·ª£c chu·∫©n h√≥a sau khi t·∫£i (logic gi·ªØ nguy√™n)
                 config.questions = config.questions.map(q => {
                    const sectionKey = q.section.replace(/\s/g, '');
                    const sectionData = config.points[sectionKey];
                    const pointPerQ = sectionData ? sectionData.perQ : q.pointValue; 
                    
                    if (q.section === 'Ph·∫ßn III' && q.correctDetails && q.correctDetails.answers) {
                        while (q.correctDetails.answers.length < 4) {
                            q.correctDetails.answers.push(""); 
                        }
                        if (q.correctDetails.answers.length > 4) {
                            q.correctDetails.answers = q.correctDetails.answers.slice(0, 4);
                        }
                    }
                    
                    return {
                        ...q,
                        correctIndex: q.options ? q.options.indexOf(q.answer) : -1,
                        pointValue: pointPerQ,
                    };
                });
            });
            return configData;
        }

        function saveExamConfig(config) {
            localStorage.setItem(STORAGE_KEY_CONFIG, JSON.stringify(config));
        }

        function loadAccounts() {
            const rawData = localStorage.getItem(STORAGE_KEY_ACCOUNTS);
            return rawData ? JSON.parse(rawData) : [];
        }

        function saveAccounts(accounts) {
            localStorage.setItem(STORAGE_KEY_ACCOUNTS, JSON.stringify(accounts));
        }
        
        function validateSBD(sbd) {
            return /^\d{8}$/.test(sbd);
        }
        
        // H√†m x√°o tr·ªôn (Fisher-Yates) d·ª±a tr√™n M√£ ƒë·ªÅ (s·ª≠ d·ª•ng M√£ ƒë·ªÅ l√†m seed)
        function shuffleArray(array, seed) {
            let prng = mulberry32(seed);
            let currentIndex = array.length, randomIndex;
            
            while (currentIndex !== 0) {
                randomIndex = Math.floor(prng() * currentIndex);
                currentIndex--;

                [array[currentIndex], array[randomIndex]] = [
                    array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        function mulberry32(a) {
            return function() {
              a |= 0; a = a + 0x6D2B79F5 | 0;
              let t = a;
              t = Math.imul(t ^ t >>> 15, 1 | t);
              t = t ^ t << 13;
              t = t ^ t >>> 6;
              t = Math.imul(t, 63 | t);
              return ((t ^ t >>> 16) >>> 0) / 4294967296;
            }
        }
        
        // --- H√ÄM CHUNG ---
        function changeScreen(newScreenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active-screen');
                screen.style.display = 'none';
            });
            const newScreen = document.getElementById(newScreenId);
            newScreen.classList.add('active-screen');
            newScreen.style.display = 'flex';
            currentScreen = newScreenId;

            if (newScreenId === 'exam-screen') {
                if (activeExamConfig) {
                    initializeExam();
                    startTimer();
                } else {
                    // Tr√°nh v√†o m√†n h√¨nh thi khi ch∆∞a c√≥ config
                    changeScreen('subject-selection-screen');
                }
            } else if (newScreenId === 'subject-selection-screen') {
                document.getElementById('info-ho_ten').textContent = userInfo.ho_ten || '...';
                document.getElementById('info-sbd').textContent = userInfo.ma_thi_sinh || '...';
                renderSubjectList(); 
            } else if (newScreenId === 'admin-screen') {
                loadStudentResults();
            } else if (newScreenId === 'exam-editor-screen') {
                loadEditorData();
            } else if (newScreenId === 'account-management-screen') {
                renderAccountManagementScreen();
            } else {
                stopTimer();
            }
        }

        // --- 1. Logic ƒêƒÉng nh·∫≠p (Admin/Th√≠ sinh) ---
        function login() {
            const maSo = document.getElementById('ma_thi_sinh').value.trim();
            const hoTen = document.getElementById('ho_ten').value.trim();
            const matKhau = document.getElementById('mat_khau').value;
            const errorElement = document.getElementById('login-error');
            errorElement.classList.add('hidden');

            console.log(`Attempting login for MaSo: ${maSo}, MatKhau: ${matKhau}`);

            // 1. Ki·ªÉm tra Admin
            if (maSo === ADMIN_CODE && matKhau === ADMIN_PASS) {
                console.log("Admin login successful.");
                changeScreen('admin-screen');
                return;
            }
            
            // 2. Validation SBD cho th√≠ sinh
            if (maSo !== ADMIN_CODE && !validateSBD(maSo)) {
                errorElement.textContent = `S·ªë b√°o danh (SBD) ph·∫£i l√† ${SBD_LENGTH} ch·ªØ s·ªë.`;
                errorElement.classList.remove('hidden');
                console.log("Login failed: Invalid SBD format.");
                return;
            }
            
            // 3. Ki·ªÉm tra T√†i kho·∫£n ƒë√£ t·∫°o (SBD 8 ch·ªØ s·ªë)
            const accounts = loadAccounts();
            const studentAccount = accounts.find(acc => acc.sbd === maSo && acc.password === matKhau);

            if (studentAccount) {
                userInfo.ho_ten = studentAccount.name;
                userInfo.ma_thi_sinh = studentAccount.sbd;
                console.log(`Student account login successful for: ${studentAccount.name}`);
                changeScreen('subject-selection-screen');
                return;
            }
            
            // 4. Ki·ªÉm tra T√†i kho·∫£n m·∫∑c ƒë·ªãnh (M·∫≠t kh·∫©u m·∫∑c ƒë·ªãnh v√† SBD 8 ch·ªØ s·ªë)
            if (matKhau === STUDENT_DEFAULT_PASS && validateSBD(maSo)) {
                userInfo.ho_ten = hoTen || 'Th√≠ sinh ·∫©n danh';
                userInfo.ma_thi_sinh = maSo; 
                console.log(`Default student login successful for SBD: ${maSo}`);
                changeScreen('subject-selection-screen');
                return;
            }

            // 5. ƒêƒÉng nh·∫≠p th·∫•t b·∫°i
            errorElement.textContent = "Th√¥ng tin ƒëƒÉng nh·∫≠p kh√¥ng h·ª£p l·ªá ho·∫∑c M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.";
            errorElement.classList.remove('hidden');
            console.log("Login failed: Credentials mismatch or account not found.");
        }

        // --- 2. Logic Ch·ªçn ƒë·ªÅ thi (Th√≠ sinh) ---

        function renderSubjectList() {
            const container = document.getElementById('subject-list');
            container.innerHTML = ALL_SUBJECTS
                .map(subject => {
                    const isReady = subject.status === 'ready';
                    const isOptions = subject.status === 'options';

                    let buttonHtml;
                    if (isReady) {
                        buttonHtml = `<button onclick="showClassLoginModal('${subject.key}', '${subject.name}')" class="btn-primary py-1 px-4 text-sm">V√†o thi</button>`;
                    } else if (isOptions) {
                        // K√≠ch ho·∫°t modal ch·ªçn sub-m√¥n
                        buttonHtml = `<button onclick="showSubjectOptionsModal('${subject.key}', '${subject.name}', ${JSON.stringify(subject.options)})" class="btn-primary py-1 px-4 text-sm bg-purple-500 hover:bg-purple-600">Ch·ªçn m√¥n</button>`;
                    } else {
                        buttonHtml = `<button class="btn-secondary py-1 px-4 text-sm cursor-not-allowed" disabled>V√†o thi</button>`;
                    }

                    const cardClass = isReady ? 'bg-white border-blue-400' : 
                                      isOptions ? 'bg-purple-100 border-purple-400' : 'bg-gray-200 border-gray-300 opacity-70';

                    return `
                        <div class="flex justify-between items-center p-3 border rounded-md ${cardClass}">
                            <span class="font-medium text-gray-700">${subject.name}</span>
                            ${buttonHtml}
                        </div>
                    `;
                }).join('');
        }
        
        // Hi·ªÉn th·ªã Modal t√πy ch·ªçn sub-m√¥n
        function showSubjectOptionsModal(subjectKey, subjectName, options) {
            const modal = document.getElementById('subject-option-modal');

            document.getElementById('modal-subject-title').textContent = `Ch·ªçn m√¥n ${subjectName}:`;
            
            // Map options ƒë·ªÉ t·∫°o button, s·ª≠ d·ª•ng option.name v√† key ch√≠nh x√°c cho h√†m showClassLoginModal
            document.getElementById('modal-options-container').innerHTML = options.map(option => `
                <button onclick="showClassLoginModal('${option.key}', '${subjectName} (${option.name})')" 
                        class="btn-primary w-full py-2 bg-indigo-500 hover:bg-indigo-600 text-sm">
                    ${option.name}
                </button>
            `).join('');

            modal.classList.remove('hidden');
            modal.classList.add('open');
        }

        function hideSubjectOptionsModal() {
            const modal = document.getElementById('subject-option-modal');
            modal.classList.remove('open');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }


        // Hi·ªÉn th·ªã Modal nh·∫≠p M√£ l·ªõp/M·∫≠t kh·∫©u
        function showClassLoginModal(subjectKey, subjectDisplayName) {
            const modal = document.getElementById('class-login-modal');
            document.getElementById('modal-subject-name').textContent = subjectDisplayName;
            document.getElementById('class-login-error').classList.add('hidden');
            
            // C·∫≠p nh·∫≠t s·ª± ki·ªán submit ƒë·ªÉ truy·ªÅn key ch√≠nh x√°c
            document.getElementById('class-login-form').onsubmit = (e) => {
                e.preventDefault();
                startExamAttempt(subjectKey, subjectDisplayName);
            };

            // N·∫øu modal ch·ªçn sub-m√¥n ƒëang m·ªü, ƒë√≥ng n√≥ tr∆∞·ªõc
            hideSubjectOptionsModal();
            
            modal.classList.remove('hidden');
            modal.classList.add('open');
        }

        function hideClassLoginModal() {
            const modal = document.getElementById('class-login-modal');
            modal.classList.remove('open');
            setTimeout(() => modal.classList.add('hidden'), 300);
            document.getElementById('class-login-form').reset();
        }

        // X·ª≠ l√Ω logic v√†o thi sau khi nh·∫≠p M√£ l·ªõp/M·∫≠t kh·∫©u
        function startExamAttempt(subjectKey, subjectDisplayName) {
            const classCode = document.getElementById('class_code_input').value.trim();
            const classPass = document.getElementById('class_password_input').value;
            const errorElement = document.getElementById('class-login-error');
            errorElement.classList.add('hidden');

            const configData = loadExamConfig();
            // C·∫•u h√¨nh ƒë∆∞·ª£c t√¨m ki·∫øm d·ª±a tr√™n Subject Key v√† M√£ L·ªõp
            const config = configData.configs.find(c => 
                c.subjectKey === subjectKey && 
                c.className === classCode && 
                c.classPass === classPass
            );

            if (!config) {
                errorElement.textContent = `Kh√¥ng t√¨m th·∫•y l·ªõp thi ho·∫∑c M√£ l·ªõp/M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng cho m√¥n ${subjectDisplayName}.`;
                errorElement.classList.remove('hidden');
                return;
            }
            
            activeExamConfig = JSON.parse(JSON.stringify(config));

            // 2. Ch·ªçn ng·∫´u nhi√™n M√£ ƒë·ªÅ (shuffle key) - M√£ ƒë·ªÅ 4 ch·ªØ s·ªë
            const availableCodes = activeExamConfig.examCodes || ['0000']; 
            const randomCodes = availableCodes.filter(code => code !== '0000');
            const examCodeToUse = randomCodes.length > 0 
                ? randomCodes[Math.floor(Math.random() * randomCodes.length)]
                : '0000'; 

            // 3. X√°o tr·ªôn c√¢u h·ªèi d·ª±a tr√™n M√£ ƒë·ªÅ (s·ª≠ d·ª•ng M√£ ƒë·ªÅ l√†m seed)
            const seed = parseInt(examCodeToUse, 10);
            activeExamConfig.questions = shuffleArray(activeExamConfig.questions, seed);
            
            // C·∫≠p nh·∫≠t giao di·ªán v√† chuy·ªÉn m√†n h√¨nh
            userInfo.exam_code = examCodeToUse;
            userInfo.class_code = classCode;
            userInfo.subject_name = subjectDisplayName;
            
            document.getElementById('exam-ho_ten').textContent = userInfo.ho_ten;
            document.getElementById('exam-sbd').textContent = userInfo.ma_thi_sinh;
            document.getElementById('exam-subject-display').textContent = subjectDisplayName;
            document.getElementById('exam-class-display').textContent = classCode;
            document.getElementById('exam-code-display').textContent = examCodeToUse; 

            hideClassLoginModal();
            changeScreen('exam-screen');
        }
        
        // --- 2B. Logic Admin Qu·∫£n l√Ω K·∫øt qu·∫£ ---
        
        function loadStudentResults() {
            const rawData = localStorage.getItem(STORAGE_KEY_RESULTS);
            let results = rawData ? JSON.parse(rawData) : [];
            const container = document.getElementById('student-list');
            
            // L·∫•y danh s√°ch configs ƒë·ªÉ t·∫°o b·ªô l·ªçc
            const filterSubject = document.getElementById('filter-subject');
            const filterClass = document.getElementById('filter-class');
            
            // T·∫°o b·ªô l·ªçc m√¥n thi
            const availableSubjects = [...new Set(results.map(r => r.subject_name).filter(Boolean))];
            filterSubject.innerHTML = `<option value="">-- L·ªçc theo M√¥n --</option>` + availableSubjects.map(s => `<option value="${s}">${s}</option>`).join('');
            
            // T·∫°o b·ªô l·ªçc m√£ l·ªõp
            const availableClasses = [...new Set(results.map(r => r.class_code).filter(Boolean))];
            filterClass.innerHTML = `<option value="">-- L·ªçc theo M√£ l·ªõp --</option>` + availableClasses.map(c => `<option value="${c}">${c}</option>`).join('');
            
            // √Åp d·ª•ng l·ªçc
            const currentSubjectFilter = filterSubject.value;
            const currentClassFilter = filterClass.value;
            
            if (currentSubjectFilter) {
                results = results.filter(r => r.subject_name === currentSubjectFilter);
            }
            if (currentClassFilter) {
                results = results.filter(r => r.class_code === currentClassFilter);
            }

            container.innerHTML = ''; 
            if (results.length === 0) {
                container.innerHTML = `<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">Ch∆∞a c√≥ th√≠ sinh n√†o n·ªôp b√†i ho·∫∑c kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ theo b·ªô l·ªçc.</td></tr>`;
                return;
            }

            results.sort((a, b) => b.timestamp - a.timestamp).forEach((student, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">${student.subject_name || '---'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600">${student.class_code || '---'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.exam_code || '---'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-lg font-bold text-red-600">${parseFloat(student.score).toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(student.timestamp).toLocaleString('vi-VN')}</td>
                `;
                container.appendChild(row);
            });
        }
        
        // C·∫≠p nh·∫≠t h√†m resetTestData
        function resetTestData() {
            if (confirm("C·∫¢NH B√ÅO: H√†nh ƒë·ªông n√†y s·∫Ω X√ìA TO√ÄN B·ªò K·∫æT QU·∫¢ THI v√† T√ÄI KHO·∫¢N TH√ç SINH ƒë√£ l∆∞u. B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c?")) {
                localStorage.removeItem(STORAGE_KEY_RESULTS);
                localStorage.removeItem(STORAGE_KEY_ACCOUNTS);
                // alert("ƒê√£ reset th√†nh c√¥ng d·ªØ li·ªáu k·∫øt qu·∫£ thi v√† t√†i kho·∫£n th√≠ sinh.");
                loadStudentResults(); 
                renderAccountManagementScreen();
            }
        }


        // --- 2D. Logic Qu·∫£n l√Ω T√†i kho·∫£n ---
        
        function renderAccountManagementScreen() {
            renderAccountsTable();
            document.getElementById('add_account_form').onsubmit = (e) => {
                e.preventDefault();
                addAccount();
            };
        }
        
        function renderAccountsTable() {
            const accounts = loadAccounts();
            const tableBody = document.getElementById('accounts_table');
            document.getElementById('account_count').textContent = accounts.length;
            tableBody.innerHTML = '';
            
            accounts.forEach((acc) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${acc.sbd}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${acc.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${acc.password}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button onclick="removeAccount('${acc.sbd}')" class="text-red-600 hover:text-red-900">X√≥a</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function addAccount() {
            const sbd = document.getElementById('new_sbd').value.trim();
            const name = document.getElementById('new_name').value.trim();
            const password = document.getElementById('new_password').value;
            
            if (!sbd || !name || !password) {
                // alert("Vui l√≤ng nh·∫≠p ƒë·ªß M√£ s·ªë/SBD, H·ªç v√† t√™n, v√† M·∫≠t kh·∫©u.");
                return;
            }
            
            if (!validateSBD(sbd)) {
                // alert(`M√£ s·ªë/SBD ph·∫£i l√† ${SBD_LENGTH} ch·ªØ s·ªë.`);
                return;
            }

            let accounts = loadAccounts();
            if (accounts.some(acc => acc.sbd === sbd)) {
                // alert(`M√£ s·ªë/SBD ${sbd} ƒë√£ t·ªìn t·∫°i. Vui l√≤ng nh·∫≠p M√£ s·ªë kh√°c.`);
                return;
            }
            
            accounts.push({ sbd, name, password });
            saveAccounts(accounts);
            
            document.getElementById('add_account_form').reset();
            renderAccountsTable();
            // alert(`T·∫°o t√†i kho·∫£n th√†nh c√¥ng cho: ${name} (SBD: ${sbd})`);
        }
        
        function removeAccount(sbdToRemove) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t√†i kho·∫£n SBD: ${sbdToRemove} kh√¥ng?`)) return;
            
            let accounts = loadAccounts();
            accounts = accounts.filter(acc => acc.sbd !== sbdToRemove);
            saveAccounts(accounts);
            renderAccountsTable();
        }

        // --- 2C. Logic Admin Editor ---

        let editorQuestions = [];
        let editorExamConfig = null; 

        function loadEditorData() {
            const configData = loadExamConfig();
            
            // T·∫°m th·ªùi ch·ªâ h·ªó tr·ª£ ch·ªânh s·ª≠a c·∫•u h√¨nh H√≥a h·ªçc (HOAHOC)
            editorExamConfig = configData.configs.find(c => c.subjectKey === 'HOAHOC');
            if (!editorExamConfig) {
                 editorExamConfig = DEFAULT_EXAM_DATA;
                 configData.configs.push(editorExamConfig);
                 saveExamConfig(configData);
            }

            editorQuestions = JSON.parse(JSON.stringify(editorExamConfig.questions));
            
            // C·∫≠p nh·∫≠t giao di·ªán editor
            const subjectSelect = document.getElementById('editor-subject-select');
            // L·ªçc ra c√°c m√¥n ch√≠nh ƒë·ªÉ Admin c√≥ th·ªÉ ch·ªçn
            const mainSubjects = ALL_SUBJECTS.filter(s => s.status !== 'options');
            
            // L·∫•y danh s√°ch c√°c sub-m√¥n (flat)
            const subOptions = ALL_SUBJECTS
                .filter(s => s.status === 'options')
                .flatMap(s => s.options.map(opt => ({ ...opt, parentName: s.name })));

            // T·∫°o danh s√°ch t·∫•t c·∫£ c√°c m√¥n c√≥ th·ªÉ ch·ªânh s·ª≠a
            const allEditableSubjects = [
                ...mainSubjects,
                ...subOptions
            ].filter(s => s.key); 
            
            subjectSelect.innerHTML = allEditableSubjects
                .map(s => {
                    const displayName = s.parentName ? `${s.parentName} (${s.name})` : s.name;
                    return `<option value="${s.key}" ${s.key === editorExamConfig.subjectKey ? 'selected' : ''}>${displayName}</option>`;
                }).join('');
                
            document.getElementById('editor-class-code').value = editorExamConfig.className;
            document.getElementById('editor-class-password').value = editorExamConfig.classPass;
            document.getElementById('editor-time-limit').value = editorExamConfig.timeLimit / 60;

            renderEditorQuestions();
            renderExamCodesListEditor();
        }

        function renderExamCodesListEditor() {
            const container = document.getElementById('exam_codes_list_editor');
            container.innerHTML = '';
            
            const codes = editorExamConfig.examCodes || ['0000'];
            
            // M√£ ƒë·ªÅ g·ªëc l√† '0000'
            if (codes.length === 1 && codes[0] === '0000') {
                container.innerHTML = `<span class="text-sm text-gray-500">Ch∆∞a c√≥ M√£ ƒë·ªÅ ng·∫´u nhi√™n n√†o. M√£ ƒë·ªÅ g·ªëc (0000) s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng.</span>`;
            }

            // Ch·ªâ hi·ªÉn th·ªã c√°c m√£ ƒë·ªÅ > 0000
            codes.filter(code => code !== '0000').forEach(code => {
                const badge = document.createElement('span');
                badge.className = 'bg-blue-200 text-blue-800 text-sm font-medium px-3 py-1 rounded-full flex items-center space-x-2';
                badge.innerHTML = `
                    <span>${code} (Shuffle Key)</span>
                    <button onclick="removeExamCodeEditor('${code}')" class="text-red-600 hover:text-red-800 text-base leading-none ml-1">&times;</button>
                `;
                container.appendChild(badge);
            });
        }

        function generateRandomExamCode() {
            let newCode;
            const codes = editorExamConfig.examCodes || ['0000'];
            
            // T·∫°o m√£ 4 ch·ªØ s·ªë, kh√¥ng tr√πng v·ªõi m√£ hi·ªán c√≥
            do {
                newCode = Math.floor(Math.random() * 9000) + 1000; // 1000 -> 9999
                newCode = String(newCode).padStart(EXAM_CODE_LENGTH, '0');
            } while (codes.includes(newCode) || newCode === '0000');
            
            if (!editorExamConfig.examCodes) editorExamConfig.examCodes = ['0000'];
            editorExamConfig.examCodes.push(newCode);
            renderExamCodesListEditor();
            // alert(`ƒê√£ th√™m M√£ ƒë·ªÅ ng·∫´u nhi√™n: ${newCode}`);
        }

        function removeExamCodeEditor(codeToRemove) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a M√£ ƒë·ªÅ: ${codeToRemove} kh√¥ng?`)) return;
            
            editorExamConfig.examCodes = (editorExamConfig.examCodes || ['0000']).filter(code => code !== codeToRemove);
            renderExamCodesListEditor();
        }
        
        // H√ÄM QUAN TR·ªåNG: RENDER GIAO DI·ªÜN CH·ªàNH S·ª¨A C√ÇU H·ªéI
        function renderEditorQuestions() {
            const container = document.getElementById('questions-editor-container');
            container.innerHTML = '';
            document.getElementById('editor-question-count').textContent = editorQuestions.length;

            editorQuestions.forEach((q, index) => {
                const qId = q.id || (index + 1);
                const isMC = q.section === 'Ph·∫ßn I';
                const isTF = q.section === 'Ph·∫ßn II';
                const isNumeric = q.section === 'Ph·∫ßn III';
                
                let answerInputHtml = '';
                
                if (isMC) {
                    const optionsHtml = (q.options || ["", "", "", ""]).map((opt, optIndex) => `
                        <div class="option-input-group">
                            <input type="radio" name="correct_answer_${qId}" value="${optIndex}" ${q.correctIndex === optIndex ? 'checked' : ''}>
                            <input type="text" data-type="option" data-index="${optIndex}" value="${opt}" placeholder="N·ªôi dung ƒë√°p √°n ${String.fromCharCode(65 + optIndex)}" class="flex-grow border border-gray-300 rounded-md p-1.5 text-sm">
                        </div>
                    `).join('');
                    answerInputHtml = `<label class="block text-sm font-medium text-gray-700 mb-2">ƒê√°p √°n (Ch·ªçn ƒë√∫ng A, B, C ho·∫∑c D)</label><div class="space-y-2">${optionsHtml}</div>`;
                } else if (isTF) {
                    const correctAnswers = q.correctDetails.correctAnswers || [false, false, false, false];
                    const subOptions = q.correctDetails.subOptions || ["√ù a", "√ù b", "√ù c", "√ù d"];
                    
                    answerInputHtml = `
                        <label class="block text-sm font-medium text-gray-700 mb-2">ƒê√°p √°n (Ch·ªçn ƒê√öNG/SAI cho m·ªói √Ω)</label>
                        <div class="space-y-2">
                        ${[0, 1, 2, 3].map(i => `
                            <div class="option-input-group justify-between bg-white p-2 rounded-md border">
                                <span class="font-medium text-sm w-12">√ù ${String.fromCharCode(97 + i)}:</span>
                                
                                <input type="text" data-type="suboption" data-index="${i}" value="${subOptions[i] || ''}" placeholder="N·ªôi dung √Ω ${String.fromCharCode(97 + i)}" class="flex-grow border border-gray-300 rounded-md p-1.5 text-sm mr-4">
                                
                                <label class="flex items-center text-green-600 mr-2">
                                    <input type="radio" name="tf_answer_${qId}_${i}" value="true" ${correctAnswers[i] ? 'checked' : ''} class="h-4 w-4">
                                    <span class="ml-1 text-sm">ƒê√∫ng</span>
                                </label>
                                <label class="flex items-center text-red-600">
                                    <input type="radio" name="tf_answer_${qId}_${i}" value="false" ${!correctAnswers[i] ? 'checked' : ''} class="h-4 w-4">
                                    <span class="ml-1 text-sm">Sai</span>
                                </label>
                            </div>
                        `).join('')}
                        </div>
                    `;
                } else if (isNumeric) {
                    const answers = q.correctDetails.answers || ["", "", "", ""];
                    answerInputHtml = `
                        <label class="block text-sm font-medium text-gray-700 mb-2">ƒê√°p √°n (Nh·∫≠p t·ªëi ƒëa 4 gi√° tr·ªã s·ªë ho·∫∑c k√Ω t·ª± cho 4 √¥)</label>
                        <div class="grid grid-cols-4 gap-2">
                            ${[0, 1, 2, 3].map(i => `
                                <input type="text" data-type="numeric_answer" data-index="${i}" value="${answers[i] || ''}" placeholder="√î ${i + 1}" class="block w-full border border-gray-300 rounded-md p-1.5 text-center font-mono">
                            `).join('')}
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Ghi ch√∫: Th√≠ sinh ph·∫£i ƒëi·ªÅn ƒë√∫ng gi√° tr·ªã v√†o c√°c √¥ c√≥ Admin nh·∫≠p ƒë√°p √°n.</p>
                    `;
                }

                const questionItem = document.createElement('div');
                questionItem.className = 'question-item';
                questionItem.setAttribute('data-index', index);
                questionItem.innerHTML = `
                    <div class="flex justify-between items-center mb-3 border-b pb-2">
                        <h4 class="font-bold text-base text-gray-800">C√¢u ${qId}</h4>
                        <button onclick="removeQuestionEditor(${index})" class="text-red-500 hover:text-red-700 text-sm">X√≥a c√¢u</button>
                    </div>

                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700">Ph·∫ßn thi</label>
                        <select data-type="section-selector" onchange="updateQuestionType(${index}, this.value)" class="mt-1 block w-full border border-gray-300 rounded-md p-1.5">
                            <option value="Ph·∫ßn I" ${q.section === 'Ph·∫ßn I' ? 'selected' : ''}>Ph·∫ßn I (Tr·∫Øc nghi·ªám A, B, C, D)</option>
                            <option value="Ph·∫ßn II" ${q.section === 'Ph·∫ßn II' ? 'selected' : ''}>Ph·∫ßn II (Tr·∫Øc nghi·ªám ƒê√∫ng/Sai cho 4 √Ω)</option>
                            <option value="Ph·∫ßn III" ${q.section === 'Ph·∫ßn III' ? 'selected' : ''}>Ph·∫ßn III (ƒêi·ªÅn s·ªë/k√Ω t·ª± v√†o 4 √¥)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700">ƒêi·ªÉm cho c√¢u n√†y (VD: 0.25 ho·∫∑c 1.0)</label>
                        <input type="number" step="0.01" data-type="point" value="${q.pointValue}" placeholder="ƒêi·ªÉm" class="mt-1 block w-full border border-gray-300 rounded-md p-1.5">
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700">N·ªôi dung C√¢u h·ªèi (H·ªó tr·ª£ Markdown c∆° b·∫£n/LaTeX)</label>
                        <textarea data-type="text" placeholder="N·ªôi dung c√¢u h·ªèi (s·ª≠ d·ª•ng Enter ƒë·ªÉ xu·ªëng d√≤ng)" rows="4" class="mt-1 block w-full border border-gray-300 rounded-md p-1.5">${q.text}</textarea>
                    </div>
                    
                    ${answerInputHtml}
                `;
                container.appendChild(questionItem);
            });
        }
        
        function updateQuestionType(index, newSection) {
            const q = editorQuestions[index];
            q.section = newSection;
            
            if (newSection === 'Ph·∫ßn I') {
                q.correctDetails = { type: 'MC', answerIndex: 0 };
                q.options = q.options || ["", "", "", ""];
                q.pointValue = q.pointValue || 0.25;
            } else if (newSection === 'Ph·∫ßn II') {
                q.correctDetails = { type: 'TF', correctAnswers: [true, false, false, false], subOptions: ["√ù a", "√ù b", "√ù c", "√ù d"] };
                q.options = ["ƒê√∫ng/Sai", "ƒê√∫ng/Sai", "ƒê√∫ng/Sai", "ƒê√∫ng/Sai"]; 
                q.pointValue = q.pointValue || 1.0;
            } else if (newSection === 'Ph·∫ßn III') {
                q.correctDetails = { type: 'NUMERIC', answers: ["", "", "", ""] };
                q.options = ["Gi√° tr·ªã 1", "Gi√° tr·ªã 2", "Gi√° tr·ªã 3", "Gi√° tr·ªã 4"]; 
                q.pointValue = q.pointValue || 0.25;
            }
            
            renderEditorQuestions();
        }

        function addQuestionEditor() {
            const newId = editorQuestions.length > 0 ? editorQuestions[editorQuestions.length - 1].id + 1 : 1;
            const newQuestion = {
                id: newId,
                section: "Ph·∫ßn I",
                text: "N·ªôi dung c√¢u h·ªèi m·ªõi...",
                options: ["ƒê√°p √°n A", "ƒê√°p √°n B", "ƒê√°p √°n C", "ƒê√°p √°n D"],
                answer: "ƒê√°p √°n A",
                correctIndex: 0,
                pointValue: 0.25,
                correctDetails: { type: 'MC', answerIndex: 0 }
            };
            editorQuestions.push(newQuestion);
            renderEditorQuestions();
            document.getElementById('questions-editor-container').lastChild.scrollIntoView({ behavior: 'smooth' });
        }

        function removeQuestionEditor(index) {
            if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a C√¢u ${editorQuestions[index].id} kh√¥ng?`)) {
                editorQuestions.splice(index, 1);
                renderEditorQuestions();
            }
        }
        
        function saveExamData() {
            const newExamData = {};
            const timeLimitMin = parseInt(document.getElementById('editor-time-limit').value);
            const totalPoints = parseFloat(document.getElementById('editor-total-points').value);
            const subjectKey = document.getElementById('editor-subject-select').value;
            const className = document.getElementById('editor-class-code').value.trim();
            const classPass = document.getElementById('editor-class-password').value;
            
            newExamData.subjectKey = subjectKey;
            newExamData.className = className;
            newExamData.classPass = classPass;
            newExamData.timeLimit = timeLimitMin * 60;
            newExamData.points = {};
            newExamData.questions = [];
            
            let tempPoints = {}; 
            let totalActualPoints = 0;
            let hasError = false;

            document.querySelectorAll('.question-item').forEach((item, index) => {
                if (hasError) return;
                
                const q = {};
                const qId = index + 1; 
                const pointValue = parseFloat(item.querySelector('[data-type="point"]').value) || 0;
                const section = item.querySelector('[data-type="section-selector"]').value;
                
                if (!className || !classPass) {
                    // alert("L·ªói: Vui l√≤ng nh·∫≠p M√£ L·ªõp Thi v√† M·∫≠t kh·∫©u L·ªõp Thi.");
                    hasError = true;
                    return;
                }

                q.id = qId;
                q.section = section;
                q.text = item.querySelector('[data-type="text"]').value.trim();
                q.pointValue = pointValue;
                
                // START: Logic c·∫≠p nh·∫≠t ƒë√°p √°n cho t·ª´ng ph·∫ßn
                q.options = [];
                q.correctDetails = { type: (section === 'Ph·∫ßn I' ? 'MC' : section === 'Ph·∫ßn II' ? 'TF' : 'NUMERIC') };
                
                if (section === 'Ph·∫ßn I') {
                    // PH·∫¶N I: MC
                    let correctIndex = -1;
                    item.querySelectorAll('.option-input-group').forEach((group, optIndex) => {
                        const optionText = group.querySelector('[data-type="option"]').value.trim();
                        q.options.push(optionText);
                        if (group.querySelector('input[type="radio"]').checked) {
                            correctIndex = optIndex;
                        }
                    });

                    if (correctIndex === -1) {
                        // alert(`C√¢u ${qId} (Ph·∫ßn I) ch∆∞a ch·ªçn ƒë√°p √°n ƒë√∫ng!`);
                        hasError = true;
                        return; 
                    }
                    q.answer = q.options[correctIndex];
                    q.correctIndex = correctIndex;
                    q.correctDetails.answerIndex = correctIndex; 
                } else if (section === 'Ph·∫ßn II') {
                    // PH·∫¶N II: T/F
                    q.options = ["ƒê√∫ng/Sai", "ƒê√∫ng/Sai", "ƒê√∫ng/Sai", "ƒê√∫ng/Sai"]; 
                    q.correctDetails.correctAnswers = [];
                    q.correctDetails.subOptions = [];
                    
                    let allSubOptionsValid = true;
                    item.querySelectorAll('.option-input-group').forEach((group, i) => {
                        const isCorrect = group.querySelector(`input[name="tf_answer_${qId}_${i}"][value="true"]`).checked;
                        const subOptionText = group.querySelector('[data-type="suboption"]').value.trim();
                        
                        q.correctDetails.correctAnswers.push(isCorrect);
                        q.correctDetails.subOptions.push(subOptionText);

                        if (!subOptionText && allSubOptionsValid) {
                             // alert(`L·ªói: C√¢u ${qId} (Ph·∫ßn II), n·ªôi dung √Ω ${String.fromCharCode(97 + i)} kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.`);
                             hasError = true;
                             allSubOptionsValid = false;
                        }
                    });
                    if (hasError) return;

                    q.answer = q.correctDetails.correctAnswers.map(c => c ? 'ƒê' : 'S').join('');
                    q.correctIndex = 0; 
                } else if (section === 'Ph·∫ßn III') {
                    // PH·∫¶N III: NUMERIC
                    q.options = ["Gi√° tr·ªã 1", "Gi√° tr·ªã 2", "Gi√° tr·ªã 3", "Gi√° tr·ªã 4"]; 
                    q.correctDetails.answers = Array.from(item.querySelectorAll('[data-type="numeric_answer"]')).map(input => input.value.trim());
                    
                    const answeredCells = q.correctDetails.answers.filter(a => a !== "");

                    if (answeredCells.length === 0) {
                        // alert(`C√¢u ${qId} (Ph·∫ßn III) ph·∫£i c√≥ √≠t nh·∫•t m·ªôt gi√° tr·ªã ƒêi·ªÅn s·ªë.`);
                        hasError = true;
                        return;
                    }
                    q.answer = q.correctDetails.answers.join('|');
                    q.correctIndex = 0; 
                }
                // END: Logic c·∫≠p nh·∫≠t ƒë√°p √°n cho t·ª´ng ph·∫ßn

                
                q.selected = null;
                newExamData.questions.push(q);
                totalActualPoints += pointValue;

                const sectionKey = q.section.replace(/\s/g, '');
                if (!tempPoints[sectionKey]) {
                    tempPoints[sectionKey] = { count: 0, total: 0 };
                }
                tempPoints[sectionKey].count++;
                tempPoints[sectionKey].total += pointValue;
            });
            
            if (hasError) return;
            
            for (const key in tempPoints) {
                newExamData.points[key] = {
                    count: tempPoints[key].count,
                    total: tempPoints[key].total,
                    perQ: tempPoints[key].total / tempPoints[key].count
                };
                if (Math.abs(newExamData.points[key].perQ - newExamData.questions.find(q => q.section.replace(/\s/g, '') === key).pointValue) > 0.001) {
                    // alert(`L·ªói: Trong ${key}, c√°c c√¢u ph·∫£i c√≥ c√πng gi√° tr·ªã ƒëi·ªÉm ƒë·ªÉ t√≠nh perQ ch√≠nh x√°c.`);
                    hasError = true;
                    return;
                }
            }

            if (hasError) return;

            newExamData.totalQuestions = newExamData.questions.length;

            if (newExamData.questions.length === 0) {
                 // alert("Kh√¥ng th·ªÉ l∆∞u ƒë·ªÅ thi r·ªóng!");
                 return;
            }

            if (Math.abs(totalActualPoints - totalPoints) > 0.01) {
                // alert(`L·ªói: T·ªïng ƒëi·ªÉm th·ª±c t·∫ø (${totalActualPoints.toFixed(2)}) kh√¥ng b·∫±ng Thang ƒëi·ªÉm t·ªïng (10)! Vui l√≤ng ch·ªânh s·ª≠a ƒëi·ªÉm t·ª´ng c√¢u.`);
                return;
            }

            // C·∫≠p nh·∫≠t c·∫•u h√¨nh l·ªõp thi hi·ªán t·∫°i
            editorExamConfig.subjectKey = newExamData.subjectKey;
            editorExamConfig.className = newExamData.className;
            editorExamConfig.classPass = newExamData.classPass;
            editorExamConfig.timeLimit = newExamData.timeLimit;
            editorExamConfig.questions = newExamData.questions;
            editorExamConfig.points = newExamData.points;
            
            // L∆∞u to√†n b·ªô config
            const allConfigs = loadExamConfig();
            const configIndex = allConfigs.configs.findIndex(c => c.subjectKey === editorExamConfig.subjectKey);
            
            if (configIndex > -1) {
                allConfigs.configs[configIndex] = editorExamConfig;
            } else {
                allConfigs.configs.push(editorExamConfig);
            }

            saveExamConfig(allConfigs);
            // alert(`ƒê√£ l∆∞u th√†nh c√¥ng c·∫•u h√¨nh ƒê·ªÅ thi ${editorExamConfig.subjectKey} cho L·ªõp ${editorExamConfig.className}!`);
            changeScreen('admin-screen');
        }

        // --- C√ÅC H√ÄM THI (TH√ç SINH) ---
        
        function initializeExam() {
            currentQuestionIndex = 0;
            timeLeft = activeExamConfig.timeLimit;
            activeExamConfig.questions.forEach(q => {
                if (q.section === 'Ph·∫ßn I') q.selected = null;
                if (q.section === 'Ph·∫ßn II') q.selected = Array(4).fill(null); 
                if (q.section === 'Ph·∫ßn III') {
                    q.selected = activeExamConfig.questions.find(eq => eq.id === q.id).correctDetails.answers.map(() => ""); 
                }
            });

            document.getElementById('total-questions').textContent = activeExamConfig.questions.length;
            document.getElementById('answered-count').textContent = '0';
            updateQuestionNavigation();
            renderQuestion(currentQuestionIndex);
        }
        
        function updateTimer() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timer').textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            if (timeLeft <= 0) {
                stopTimer();
                submitExam(true); 
            } else {
                timeLeft--;
            }
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            updateTimer(); 
            timerInterval = setInterval(updateTimer, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        function renderQuestion(index) {
            const container = document.getElementById('question-container');
            const q = activeExamConfig.questions[index];

            if (!q) {
                container.innerHTML = '<div class="text-center text-red-500">Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi!</div>';
                return;
            }
            
            const isMC = q.section === 'Ph·∫ßn I';
            const isTF = q.section === 'Ph·∫ßn II';
            const isNumeric = q.section === 'Ph·∫ßn III';
            
            let questionInputHtml = '';
            
            if (isMC) {
                 questionInputHtml = q.options.map((option, optIndex) => `
                    <div class="mb-2 question-option">
                        <input type="radio" id="q${q.id}_opt${optIndex}" name="question${q.id}" value="${optIndex}" 
                            class="hidden" ${q.selected === optIndex ? 'checked' : ''}
                            onchange="handleAnswerChange(${index}, ${optIndex})">
                        <label for="q${q.id}_opt${optIndex}" class="flex items-start space-x-3">
                            <span class="font-bold text-blue-600 w-6 flex-shrink-0">${String.fromCharCode(65 + optIndex)}.</span>
                            <p>${option}</p>
                        </label>
                    </div>
                `).join('');
            } else if (isTF) {
                 const subOptions = q.correctDetails.subOptions || ["√ù a", "√ù b", "√ù c", "√ù d"];
                 questionInputHtml = subOptions.slice(0, 4).map((opt, i) => `
                     <div class="mb-3 p-3 border rounded-md flex justify-between items-center bg-gray-50">
                         <span class="font-medium text-gray-700 w-full md:w-1/2">${i + 1}. ${opt}</span>
                         <div class="flex space-x-4 flex-shrink-0">
                            <label class="flex items-center text-green-600">
                                <input type="radio" name="tf_q${q.id}_${i}" value="true" class="h-4 w-4" ${q.selected && q.selected[i] === true ? 'checked' : ''} onchange="handleTFAnswerChange(${index}, ${i}, true)">
                                <span class="ml-1 text-sm font-bold">ƒê√öNG</span>
                            </label>
                            <label class="flex items-center text-red-600">
                                <input type="radio" name="tf_q${q.id}_${i}" value="false" class="h-4 w-4" ${q.selected && q.selected[i] === false ? 'checked' : ''} onchange="handleTFAnswerChange(${index}, ${i}, false)">
                                <span class="ml-1 text-sm font-bold">SAI</span>
                            </label>
                         </div>
                     </div>
                 `).join('');
            } else if (isNumeric) {
                 questionInputHtml = `
                     <div class="flex justify-center space-x-3">
                         ${[0, 1, 2, 3].map(i => `
                            <input type="text" 
                                data-numeric-index="${i}" 
                                maxlength="1" 
                                value="${q.selected && q.selected[i] !== undefined ? q.selected[i] : ''}" 
                                oninput="handleNumericInput(event, ${index}, ${i})" 
                                onkeyup="handleNumericKeyup(event, ${index}, ${i})" 
                                placeholder="" 
                                class="numeric-input-cell">
                         `).join('')}
                     </div>
                     <p class="text-center text-sm text-gray-500 mt-4">M·ªói √¥ nh·∫≠p t·ªëi ƒëa 1 k√Ω t·ª± (s·ªë, d·∫•u '.', ',' ho·∫∑c k√Ω t·ª± kh√°c n·∫øu ƒë·ªÅ b√†i y√™u c·∫ßu).</p>
                 `;
            }

            container.innerHTML = `
                <p class="section-title text-sm">${q.section} (ƒêi·ªÉm: ${q.pointValue.toFixed(2)})</p>
                <h2 class="text-xl font-bold mb-4 text-gray-800">C√¢u ${index + 1}:</h2> 
                <div class="mb-6 border-b pb-4 text-lg whitespace-pre-wrap">${q.text}</div>
                <div class="space-y-3">
                    ${questionInputHtml}
                </div>
            `;
            
            document.querySelectorAll('#question-nav button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`nav-q-${index + 1}`).classList.add('active'); 

            currentQuestionIndex = index;
        }
        
        function handleAnswerChange(qIndex, selectedIndex) {
            const q = activeExamConfig.questions[qIndex];
            q.selected = selectedIndex;
            updateQuestionNavigation();
        }
        
        function handleTFAnswerChange(qIndex, subIndex, value) {
            const q = activeExamConfig.questions[qIndex];
            if (!q.selected) q.selected = Array(4).fill(null);
            q.selected[subIndex] = (value === true); 
            updateQuestionNavigation();
        }
        
        function handleNumericInput(event, qIndex, subIndex) {
            const input = event.target;
            const q = activeExamConfig.questions[qIndex];
            if (!q.selected) q.selected = Array(4).fill("");
            
            q.selected[subIndex] = input.value.slice(-1).toUpperCase(); 
            input.value = q.selected[subIndex]; 
            
            updateQuestionNavigation();
        }

        function handleNumericKeyup(event, qIndex, subIndex) {
            if (event.key.length === 1 && event.target.value.length === 1) {
                const nextInput = document.querySelector(`input[data-numeric-index="${subIndex + 1}"]`);
                if (nextInput) {
                    nextInput.focus();
                }
            } else if (event.key === 'Backspace' && event.target.value.length === 0) {
                 const prevInput = document.querySelector(`input[data-numeric-index="${subIndex - 1}"]`);
                if (prevInput) {
                    prevInput.focus();
                }
            }
        }
        
        function nextQuestion() {
            const nextIndex = (currentQuestionIndex + 1) % activeExamConfig.questions.length;
            renderQuestion(nextIndex);
        }
        
        function prevQuestion() {
            const prevIndex = (currentQuestionIndex - 1 + activeExamConfig.questions.length) % activeExamConfig.questions.length;
            renderQuestion(prevIndex);
        }

        function updateQuestionNavigation() {
            const navContainer = document.getElementById('question-nav');
            navContainer.innerHTML = '';
            let answeredCount = 0;
            
            const sections = activeExamConfig.questions.reduce((acc, q) => {
                if (!acc[q.section]) acc[q.section] = [];
                acc[q.section].push(q);
                return acc;
            }, {});

            activeExamConfig.questions.forEach(q => {
                let isAnswered = false;
                
                if (q.section === 'Ph·∫ßn I') {
                    isAnswered = q.selected !== null && q.selected !== undefined;
                } else if (q.section === 'Ph·∫ßn II') {
                    isAnswered = q.selected && q.selected.some(s => s !== null);
                } else if (q.section === 'Ph·∫ßn III') {
                    isAnswered = q.selected && q.selected.some(s => s !== "" && s !== undefined);
                }
                                   
                if (isAnswered) answeredCount++;
            });

            let currentQIndex = 0;
            
            for (const section in sections) {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'mb-4';
                sectionDiv.innerHTML = `<h4 class="font-semibold text-gray-700 mb-2">${section} (${sections[section].length} c√¢u)</h4>`;
                
                const buttonWrapper = document.createElement('div');
                buttonWrapper.className = 'flex flex-wrap gap-2';
                
                sections[section].forEach((q) => {
                    const displayIndex = currentQIndex + 1; // S·ª≠ d·ª•ng index th·ª±c trong m·∫£ng activeExamConfig.questions
                    
                    let isAnswered = false;
                    
                    if (q.section === 'Ph·∫ßn I') {
                        isAnswered = q.selected !== null && q.selected !== undefined;
                    } else if (q.section === 'Ph·∫ßn II') {
                        isAnswered = q.selected && q.selected.some(s => s !== null);
                    } else if (q.section === 'Ph·∫ßn III') {
                        isAnswered = q.selected && q.selected.some(s => s !== "" && s !== undefined);
                    }

                    const button = document.createElement('button');
                    button.id = `nav-q-${displayIndex}`;
                    button.className = `question-nav-item w-10 h-10 rounded-full border border-gray-300 flex items-center justify-center text-sm transition-colors ${isAnswered ? 'answered' : 'bg-white text-gray-700'}`;
                    button.textContent = displayIndex;
                    button.onclick = () => renderQuestion(displayIndex - 1); 
                    buttonWrapper.appendChild(button);
                    
                    currentQIndex++;
                });

                sectionDiv.appendChild(buttonWrapper);
                navContainer.appendChild(sectionDiv);
            }

            document.getElementById('answered-count').textContent = answeredCount;
        }
        
        // C·∫≠p nh·∫≠t h√†m saveResult (Th√™m M√£ l·ªõp v√† T√™n m√¥n)
        function saveResult(name, id, score, exam_code, class_code, subject_name) {
             const rawData = localStorage.getItem(STORAGE_KEY_RESULTS);
             const results = rawData ? JSON.parse(rawData) : [];
             results.push({ name, id, score: parseFloat(score), exam_code, class_code, subject_name, timestamp: Date.now() });
             localStorage.setItem(STORAGE_KEY_RESULTS, JSON.stringify(results));
        }

        function confirmSubmission() {
            document.getElementById('submission-modal').classList.remove('hidden');
            document.getElementById('submission-modal').classList.add('open');
        }

        function hideSubmissionModal() {
            const modal = document.getElementById('submission-modal');
            modal.classList.remove('open');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
        
        function submitExam(isAutoSubmit = false) {
            hideSubmissionModal();
            stopTimer();

            let correctCount = 0;
            let answeredCount = 0;
            let finalScore = 0;
            
            activeExamConfig.questions.forEach(q => {
                const isMC = q.section === 'Ph·∫ßn I';
                const isTF = q.section === 'Ph·∫ßn II';
                const isNumeric = q.section === 'Ph·∫ßn III';
                
                let isQuestionAnswered = false;
                let isCorrect = false;

                if (isMC) {
                    if (q.selected !== null && q.selected !== undefined) {
                        isQuestionAnswered = true;
                        if (q.selected === q.correctIndex) {
                            isCorrect = true;
                        }
                    }
                } else if (isTF) {
                    const correctAnswers = q.correctDetails.correctAnswers || Array(4).fill(false);
                    const userAnswers = q.selected || Array(4).fill(null);
                    
                    isQuestionAnswered = userAnswers.some(a => a !== null);
                    
                    if (isQuestionAnswered) {
                        // Ki·ªÉm tra t·∫•t c·∫£ c√°c √Ω ph·∫£i ƒë√∫ng
                        if (userAnswers.every((u, i) => u === correctAnswers[i])) {
                             isCorrect = true;
                        }
                    }

                } else if (isNumeric) {
                    const correctAnswers = q.correctDetails.answers.slice(0, 4) || Array(4).fill(""); 
                    const userAnswers = q.selected || Array(4).fill("");
                    
                    isQuestionAnswered = userAnswers.some(a => a !== "" && a !== undefined);

                    if (isQuestionAnswered) {
                        let matches = true;
                        
                        for (let i = 0; i < correctAnswers.length; i++) {
                            const expected = correctAnswers[i].trim().toUpperCase(); 
                            const actual = userAnswers[i].trim().toUpperCase();      

                            if (expected) {
                                if (actual === null || actual === "") {
                                    matches = false;
                                    break;
                                }
                                if (expected !== actual) {
                                    matches = false;
                                    break;
                                }
                            } else {
                                if (actual !== "") {
                                    matches = false;
                                    break;
                                }
                            }
                        }
                        isCorrect = matches;
                    }
                }
                
                // C·∫≠p nh·∫≠t s·ªë c√¢u ƒë√£ tr·∫£ l·ªùi (ch·ªâ c·∫ßn c√≥ t∆∞∆°ng t√°c)
                if (isMC && q.selected !== null) { answeredCount++; }
                else if (isTF && q.selected.some(s => s !== null)) { answeredCount++; }
                else if (isNumeric && q.selected.some(s => s !== "")) { answeredCount++; }


                if (isCorrect) {
                    correctCount++;
                    finalScore += q.pointValue;
                }
            });


            const formattedScore = finalScore.toFixed(2); 

            // 2. L∆∞u k·∫øt qu·∫£ v√†o localStorage (C·∫¨P NH·∫¨T)
            saveResult(
                userInfo.ho_ten, 
                userInfo.ma_thi_sinh, 
                formattedScore, 
                userInfo.exam_code, 
                userInfo.class_code, // Th√™m M√£ l·ªõp
                userInfo.subject_name // Th√™m T√™n m√¥n
            );

            // 3. C·∫≠p nh·∫≠t giao di·ªán k·∫øt qu·∫£
            document.getElementById('result-answered').textContent = answeredCount;
            document.getElementById('result-total').textContent = activeExamConfig.questions.length;
            document.getElementById('result-correct').textContent = correctCount;
            document.getElementById('result-score').textContent = parseFloat(formattedScore).toFixed(1); 

            // 4. Chuy·ªÉn m√†n h√¨nh
            changeScreen('result-screen');
        }


        // Kh·ªüi t·∫°o ·ª©ng d·ª•ng sau khi t·∫•t c·∫£ c√°c h√†m ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a
        loadExamConfig();
        changeScreen('login-screen');

        document.addEventListener('keydown', (e) => {
            if (currentScreen === 'exam-screen') {
                if (e.key === 'ArrowRight') {
                    nextQuestion();
                } else if (e.key === 'ArrowLeft') {
                    prevQuestion();
                }
            }
        });
        
    </script>

</body>
</html>
